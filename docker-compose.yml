services:
  observe-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: observe-mcp-server
    ports:
      - "8000:8000"
    depends_on:
      - postgres
    environment:
      # Pinecone configuration
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_DOCS_INDEX=${PINECONE_DOCS_INDEX:-observe-docs}
      - PINECONE_RUNBOOKS_INDEX=${PINECONE_RUNBOOKS_INDEX:-observe-runbooks}
      
      # Observe API credentials
      - OBSERVE_CUSTOMER_ID=${OBSERVE_CUSTOMER_ID}
      - OBSERVE_TOKEN=${OBSERVE_TOKEN}
      - OBSERVE_DOMAIN=${OBSERVE_DOMAIN:-observeinc.com}
      
      # MCP authentication
      - PUBLIC_KEY_PEM=${PUBLIC_KEY_PEM}
      
      # Smart Tools Configuration (LLM-powered tools)
      - SMART_TOOLS_LLM_PROVIDER=${SMART_TOOLS_LLM_PROVIDER:-anthropic}
      - SMART_TOOLS_API_KEY=${SMART_TOOLS_API_KEY}
      - SMART_TOOLS_MODEL=${SMART_TOOLS_MODEL:-claude-sonnet-4-20250514}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      
      # OPAL Memory System (PostgreSQL)
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=opal_memory
      - POSTGRES_USER=opal
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - OPAL_MEMORY_ENABLED=${OPAL_MEMORY_ENABLED:-true}
      - OPAL_MEMORY_SIMILARITY_THRESHOLD=${OPAL_MEMORY_SIMILARITY_THRESHOLD:-0.85}
      - OPAL_MEMORY_MAX_ENTRIES_PER_DATASET=${OPAL_MEMORY_MAX_ENTRIES_PER_DATASET:-50000}
      - OPAL_MEMORY_CLEANUP_DAYS=${OPAL_MEMORY_CLEANUP_DAYS:-90}
      
      # Docs and runbooks directories (inside container)
      - OBSERVE_DOCS_DIR=/app/observe-docs
      - OBSERVE_RUNBOOKS_DIR=/app/runbooks
    volumes:
      # Mount local directories if you want to use local docs/runbooks
      # Comment out these lines if using the built-in docs/runbooks
      - ./observe-docs:/app/observe-docs:ro
      - ./runbooks:/app/runbooks:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM); sock.settimeout(5); result = sock.connect_ex(('localhost', 8000)); sock.close(); exit(0 if result == 0 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL database for OPAL memory system with pgvector extension
  postgres:
    image: pgvector/pgvector:pg15
    container_name: observe-opal-memory
    environment:
      POSTGRES_DB: opal_memory
      POSTGRES_USER: opal
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    command: >
      postgres
      -c log_statement=none
      -c log_duration=off
      -c log_line_prefix='%t [%p]: '
      -c log_min_duration_statement=100
      -c log_connections=on
      -c log_disconnections=on
      -c logging_collector=off
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"  # Optional: expose for debugging
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U opal -d opal_memory"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Optional: Add a simple nginx proxy for production deployments
  nginx:
    image: nginx:alpine
    container_name: observe-mcp-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # - ./ssl:/etc/nginx/ssl:ro  # Mount SSL certificates if needed
    depends_on:
      - observe-mcp
    restart: unless-stopped
    profiles:
      - production  # Only start with: docker-compose --profile production up

volumes:
  postgres_data:
    driver: local

networks:
  default:
    name: observe-mcp-network